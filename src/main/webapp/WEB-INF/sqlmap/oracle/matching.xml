<?xml version="1.0" encoding="UTF-8" ?>

<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
    
<mapper namespace="matching">
	<select id="list" resultType="Map" parameterType="Map">
 	    SELECT r.region as region
            , l."LEVEL" as level_name
            , b.message as message
            , m.name as name
            , b.matched as matched
            , b.writedate as writedate
            , b.game_seq as game_seq
            , b.member_seq as member_seq
            , b.matched as matched
		FROM BOARD b INNER JOIN REGION r ON b.id_region = r.id_region
                     INNER JOIN FB_LEVEL l ON b.id_level = l.id_level
                     INNER JOIN MEMBER m ON b.member_seq = m.member_seq
 		<where>
 			<choose>
			    <when test="SEARCH_OPTION == null">
			        and 1=1
			    </when>
			    <when test="SEARCH_OPTION == 'BY_LOCATION'">
			    	and r.region LIKE '%' || #{SEARCH_KEYWORD} || '%'
			    </when>
			    <when test="SEARCH_OPTION == 'BY_LEVEL'">
			    	<!-- 대소문자 구문 안하도록 : 둘 다 소문자로 만들어서 비교. -->
			    	and lower(l."LEVEL") LIKE '%' || lower(#{SEARCH_KEYWORD}) || '%'
			    	<!-- 찐우 원본 코드
			    	and (l."LEVEL" LIKE '%' || #{SEARCH_KEYWORD} || '%' -->
			    </when>
			    <otherwise>
			    	and 1=1
			    </otherwise>
		    </choose>
		</where> 
	</select>

	<select id="read" resultType="Map" parameterType="Map">
	    SELECT b.ID_REGION as ID_REGION
            , b.ID_LEVEL as ID_LEVEL
            , b.message as message
            , m.member_seq as member_seq
            , m.name as name
            , m.email as email
            , b.matched as matched
            , b.writedate as writedate
            , b.game_seq as game_seq
		FROM BOARD b INNER JOIN MEMBER m ON b.member_seq = m.member_seq
		WHERE b.game_seq = #{GAME_SEQ}
<!-- 		<where> -->
<!-- 			<choose> -->
<!-- 		 		<when test="GAME_SEQ != null and GAME_SEQ == ''"> -->
<!-- 		    	</when> -->
<!-- 			    <otherwise> -->
<!-- 			    	and 1=1 -->
<!-- 			    </otherwise> -->
<!-- 		    </choose> -->
<!-- 		</where> -->

<!-- select * -->
<!-- from member -->
<!-- where member_seq = #{MEMBER_SEQ} -->
	</select>
	<select id="readnameemail" resultType="Map" parameterType="Map">
	    SELECT *
		FROM MEMBER
		WHERE MEMBER_SEQ = #{MEMBER_SEQ}
	</select>

	<insert id="merge" parameterType="Map">
	
		MERGE INTO BOARD B1 
		     USING (SELECT #{GAME_SEQ} AS GAME_SEQ FROM DUAL) B2
				ON (B1.GAME_SEQ = B2.GAME_SEQ)
		WHEN MATCHED THEN 
			UPDATE SET
				ID_REGION   = #{ID_REGION}
				, ID_LEVEL  = #{ID_LEVEL}
				, MESSAGE	= #{MESSAGE}
				, "MATCHED"	= #{MATCHED}
		WHEN NOT MATCHED THEN 
			INSERT(
				GAME_SEQ
				, ID_REGION
				, ID_LEVEL
				, MESSAGE
				, MEMBER_SEQ
				, "MATCHED"
				, WRITEDATE
			)
			values(
				#{GAME_SEQ}
				, #{ID_REGION}
				, #{ID_LEVEL}
				, #{MESSAGE}
				, #{MEMBER_SEQ}
				, #{MATCHED}
				, TO_CHAR(SYSDATE, 'YYYY.MM.DD HH24:MI:SS')

			)
		
	</insert>

	<delete id="delete" parameterType="Map">
		delete from BOARD
		where GAME_SEQ = #{GAME_SEQ}
	</delete>
</mapper>